<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Follow-Up Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <!-- (CSS styles as you provided above, unchanged for brevity) -->
    <style>
        /* ...all your CSS goes here, unchanged... */
    </style>
</head>
<body data-theme="light">

    <!-- ...HTML content as you provided above, unchanged... -->

    <script>
        // --- Helper Functions and Initial Setup ---
        const clientTableBody = document.getElementById('clientTableBody');
        const clientForm = document.getElementById('clientForm');
        const clientModal = document.getElementById('clientModal');
        const clientDetailsModal = document.getElementById('clientDetailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const emailModal = document.getElementById('emailModal');
        const hamdiTaskList = document.getElementById('hamdiTaskList');
        const dinaTaskList = document.getElementById('dinaTaskList');
        const statsGrid = document.getElementById('statsGrid');
        const searchInput = document.getElementById('searchClients');
        const messageBox = document.getElementById('messageBox');

        let clients = [];
        let editingClient = null;
        let selectedTemplate = null;
        let currentEmailClient = null;
        let currentDetailsClient = null;

        // --- Theme Toggle ---
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('clientTheme', newTheme);
            themeIcon.setAttribute('data-lucide', newTheme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function loadTheme() {
            const theme = localStorage.getItem('clientTheme') || 'light';
            document.body.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        // --- Notification ---
        function showMessage(text, type = 'success', timeout = 2000) {
            messageBox.textContent = text;
            messageBox.className = 'message-box visible ' + type;
            setTimeout(() => {
                messageBox.classList.remove('visible');
            }, timeout);
        }

        // --- Client Data Management ---
        function loadClients() {
            const saved = localStorage.getItem('clientTracker_clients');
            if (saved) {
                clients = JSON.parse(saved);
            } else {
                clients = [];
            }
        }
        function saveClients() {
            localStorage.setItem('clientTracker_clients', JSON.stringify(clients));
        }
        function generateClientId() {
            const maxId = clients.length > 0 ? Math.max(...clients.map(c => parseInt(c.id || '0', 10) || 0)) : 0;
            return String(maxId + 1);
        }

        // --- Rendering Functions ---
        function renderClients(filter = '') {
            let filtered = clients;
            if (filter) {
                filter = filter.toLowerCase();
                filtered = clients.filter(c =>
                    c.companyName.toLowerCase().includes(filter) ||
                    c.contactPerson.toLowerCase().includes(filter) ||
                    c.email.toLowerCase().includes(filter) ||
                    (c.rep || '').toLowerCase().includes(filter)
                );
            }
            clientTableBody.innerHTML = filtered.map(client => `
                <tr>
                    <td>${client.id}</td>
                    <td>${client.companyName}</td>
                    <td>${client.contactPerson}</td>
                    <td><span class="rep-badge ${client.rep && client.rep.toLowerCase() === 'dina' ? 'dina' : 'hamdi'}">${client.rep || ''}</span></td>
                    <td>${client.nextAction}</td>
                    <td>${client.nextFollowUp}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(client.currentStage)}">${client.currentStage}</span>
                    </td>
                    <td class="client-actions">
                        <button class="action-btn" title="Details" onclick="openClientDetailsModal('${client.id}')"><i data-lucide="info"></i></button>
                        <button class="action-btn" title="Edit" onclick="openClientModal('edit','${client.id}')"><i data-lucide="edit"></i></button>
                        <button class="action-btn" title="Delete" onclick="deleteClient('${client.id}')"><i data-lucide="trash"></i></button>
                        <button class="action-btn" title="Email" onclick="openEmailModal('${client.id}')"><i data-lucide="mail"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        function getStatusClass(stage) {
            if (!stage) return '';
            const s = stage.toLowerCase();
            if (s.includes('won')) return 'closed-won';
            if (s.includes('lost')) return 'closed-lost';
            if (s.includes('active')) return 'active';
            if (s.includes('cold')) return 'cold';
            return 'active';
        }

        function renderStats() {
            const today = new Date().toISOString().slice(0,10);
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            let dueToday = 0, meetings = 0, calls = 0, active = 0, won = 0, quotations = 0, quotationsSum = 0;
            const month = (new Date()).getMonth();

            clients.forEach(c => {
                if (c.nextFollowUp === today) dueToday++;
                if (c.currentStage && c.currentStage.toLowerCase().includes('meeting')) {
                    let meetDate = c.nextFollowUp;
                    if (meetDate && (new Date(meetDate)).getMonth() === (new Date()).getMonth()) meetings++;
                }
                if (c.nextAction && c.nextAction.toLowerCase().includes('call')) calls++;
                if (c.currentStage && c.currentStage.toLowerCase().includes('won')) {
                    won++;
                }
                if (c.currentStage && c.currentStage.toLowerCase().includes('active')) active++;
                if (c.quotationAmount) {
                    quotations++;
                    quotationsSum += parseFloat(c.quotationAmount) || 0;
                }
            });
            document.getElementById('statDueToday').textContent = dueToday;
            document.getElementById('statMeetingsThisWeek').textContent = meetings;
            document.getElementById('statPendingCalls').textContent = calls;
            document.getElementById('statActiveClients').textContent = active;
            document.getElementById('statWonThisMonth').textContent = won;
            document.getElementById('statTotalQuotations').textContent = `${quotations} ($${quotationsSum.toFixed(2)})`;
        }

        function renderTasks() {
            let hamdi = clients.filter(c => (c.rep || '').toLowerCase() === 'hamdi');
            let dina = clients.filter(c => (c.rep || '').toLowerCase() === 'dina');
            hamdiTaskList.innerHTML = hamdi.map(c => `
                <div class="task-item high">
                    <div class="task-info">
                        <div class="task-title">${c.companyName}</div>
                        <div class="task-meta">${c.nextAction} | Next: ${c.nextFollowUp}</div>
                    </div>
                </div>
            `).join('');
            dinaTaskList.innerHTML = dina.map(c => `
                <div class="task-item medium">
                    <div class="task-info">
                        <div class="task-title">${c.companyName}</div>
                        <div class="task-meta">${c.nextAction} | Next: ${c.nextFollowUp}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- Modal Controls ---
        function openClientModal(mode, clientId = null) {
            clientModal.style.display = 'flex';
            if (mode === 'edit' && clientId) {
                editingClient = clients.find(c => c.id == clientId);
                modalTitle.textContent = 'Edit Client';
                populateClientForm(editingClient);
            } else {
                editingClient = null;
                modalTitle.textContent = 'Add New Client';
                clientForm.reset();
                document.getElementById('clientId').value = '';
            }
        }
        function closeClientModal() {
            clientModal.style.display = 'none';
            editingClient = null;
        }
        function populateClientForm(client) {
            document.getElementById('clientId').value = client.id;
            document.getElementById('companyName').value = client.companyName || '';
            document.getElementById('contactPerson').value = client.contactPerson || '';
            document.getElementById('email').value = client.email || '';
            document.getElementById('phone').value = client.phone || '';
            document.getElementById('rep').value = client.rep || '';
            document.getElementById('currentStage').value = client.currentStage || '';
            document.getElementById('nextAction').value = client.nextAction || '';
            document.getElementById('nextFollowUp').value = client.nextFollowUp || '';
            document.getElementById('quotationAmount').value = client.quotationAmount || '';
        }

        clientForm.onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('clientId').value || generateClientId();
            const clientObj = {
                id,
                companyName: document.getElementById('companyName').value,
                contactPerson: document.getElementById('contactPerson').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                rep: document.getElementById('rep').value,
                currentStage: document.getElementById('currentStage').value,
                nextAction: document.getElementById('nextAction').value,
                nextFollowUp: document.getElementById('nextFollowUp').value,
                quotationAmount: document.getElementById('quotationAmount').value
            };
            if (editingClient) {
                const idx = clients.findIndex(c => c.id == id);
                clients[idx] = clientObj;
                showMessage('Client updated!', 'success', 1800);
            } else {
                clients.push(clientObj);
                showMessage('Client added!', 'success', 1800);
            }
            saveClients();
            renderClients(searchInput.value);
            renderStats();
            renderTasks();
            closeClientModal();
        };

        function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client?')) return;
            clients = clients.filter(c => c.id != clientId);
            saveClients();
            renderClients(searchInput.value);
            renderStats();
            renderTasks();
            showMessage('Client deleted.', 'warning', 1800);
        }

        // --- Client Details Modal ---
        function openClientDetailsModal(clientId) {
            currentDetailsClient = clients.find(c => c.id == clientId);
            document.getElementById('detailsModalTitle').textContent = currentDetailsClient.companyName;
            document.getElementById('clientDetailsContent').innerHTML = `
                <div class="client-details">
                    <div class="detail-item"><label>Contact:</label><div class="value">${currentDetailsClient.contactPerson}</div></div>
                    <div class="detail-item"><label>Email:</label><div class="value">${currentDetailsClient.email}</div></div>
                    <div class="detail-item"><label>Phone:</label><div class="value">${currentDetailsClient.phone}</div></div>
                    <div class="detail-item"><label>Rep:</label><div class="value">${currentDetailsClient.rep}</div></div>
                    <div class="detail-item"><label>Stage:</label><div class="value">${currentDetailsClient.currentStage}</div></div>
                    <div class="detail-item"><label>Next Action:</label><div class="value">${currentDetailsClient.nextAction}</div></div>
                    <div class="detail-item"><label>Next Follow-Up:</label><div class="value">${currentDetailsClient.nextFollowUp}</div></div>
                    <div class="detail-item"><label>Quotation:</label><div class="value">${currentDetailsClient.quotationAmount}</div></div>
                </div>
            `;
            document.getElementById('clientNotes').value = currentDetailsClient.notes || '';
            clientDetailsModal.style.display = 'flex';
        }
        function closeClientDetailsModal() {
            clientDetailsModal.style.display = 'none';
            currentDetailsClient = null;
        }
        function saveClientNotes() {
            if (!currentDetailsClient) return;
            currentDetailsClient.notes = document.getElementById('clientNotes').value;
            const idx = clients.findIndex(c => c.id == currentDetailsClient.id);
            clients[idx] = currentDetailsClient;
            saveClients();
            showMessage('Notes saved.', 'success');
        }
        function editClientFromDetails() {
            if (!currentDetailsClient) return;
            closeClientDetailsModal();
            openClientModal('edit', currentDetailsClient.id);
        }

        // --- Email Modal (templates can be filled out as needed) ---
        function openEmailModal(clientId) {
            currentEmailClient = clients.find(c => c.id == clientId);
            emailModal.style.display = 'flex';
            Array.from(document.querySelectorAll('.email-template-btn')).forEach(btn => {
                btn.classList.remove('selected');
            });
            selectedTemplate = null;
        }
        function closeEmailModal() {
            emailModal.style.display = 'none';
            currentEmailClient = null;
            selectedTemplate = null;
        }

        document.querySelectorAll('.email-template-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.email-template-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedTemplate = this.getAttribute('data-template');
            };
        });

        function sendEmail() {
            if (!currentEmailClient || !selectedTemplate) {
                showMessage('Select a template.', 'error');
                return;
            }
            let subject = '';
            let body = '';
            if (selectedTemplate === 'initial') {
                subject = `Initial Contact with ${currentEmailClient.companyName}`;
                body = `Hi ${currentEmailClient.contactPerson},\n\nI'm reaching out regarding our recent conversation...`;
            } else if (selectedTemplate === 'followUp') {
                subject = `Follow-Up: ${currentEmailClient.companyName}`;
                body = `Hi ${currentEmailClient.contactPerson},\n\nJust following up...`;
            } else if (selectedTemplate === 'proposal') {
                subject = `Proposal for ${currentEmailClient.companyName}`;
                body = `Dear ${currentEmailClient.contactPerson},\n\nPlease find attached our proposal...`;
            }
            window.open(`mailto:${currentEmailClient.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
            closeEmailModal();
        }

        // --- Table Sorting ---
        function sortByFollowUp(order) {
            clients.sort((a,b) => {
                if (!a.nextFollowUp) return 1;
                if (!b.nextFollowUp) return -1;
                if (order === 'asc') return a.nextFollowUp.localeCompare(b.nextFollowUp);
                else return b.nextFollowUp.localeCompare(a.nextFollowUp);
            });
            renderClients(searchInput.value);
        }

        function sortTable(col) {
            // Example basic sort, you can expand for more robust sort logic if needed
            let key = '';
            switch(col) {
                case 0: key = 'id'; break;
                case 1: key = 'companyName'; break;
                case 2: key = 'contactPerson'; break;
                case 3: key = 'rep'; break;
                case 4: key = 'nextAction'; break;
                case 5: key = 'nextFollowUp'; break;
                case 6: key = 'currentStage'; break;
                default: key = 'id';
            }
            clients.sort((a,b) => (a[key]||'').toString().localeCompare((b[key]||'').toString()));
            renderClients(searchInput.value);
        }

        // --- Search ---
        searchInput.oninput = function() {
            renderClients(this.value);
        };

        // --- Modal Close on Outside Click ---
        window.onclick = function(event) {
            [clientModal, clientDetailsModal, emailModal].forEach(modal => {
                if (event.target === modal) modal.style.display = "none";
            });
        };

        // --- Google Sheets Sync Integration (dummy implementation) ---
        function syncToGoogleSheets() {
            // This should be replaced with your Google Apps Script endpoint
            showMessage('Sync to Google Sheets (dummy)', 'info', 1500);
            // Example fetch:
            // fetch('https://YOUR_SCRIPT_URL', { method: 'POST', body: JSON.stringify({clients}) });
        }

        // --- Initial Load ---
        function init() {
            loadTheme();
            loadClients();
            renderClients();
            renderStats();
            renderTasks();
        }
        window.onload = init;
    </script>
</body>
</html>
